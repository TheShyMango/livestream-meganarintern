<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Live Stream + Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="container mt-4">
<div class="row">
  <!-- Video -->
  <div class="col-md-8">
    <h3>Live Stream</h3>
    <video width="100%" controls autoplay>
      <source src="/video/sample.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <!-- Chat -->
  <div class="col-md-4">
    <h3>Live Chat</h3>
    <div id="chat-box" class="border rounded p-2 mb-3" style="height: 400px; overflow-y: scroll; background-color: #f8f9fa;"></div>

    <form onsubmit="sendMessage(); return false;">
      <input type="hidden" id="username" th:value="${#authentication.name}" />
      <div class="mb-2">
        <input type="text" id="message" class="form-control" placeholder="Type your message..." required />
      </div>
      <div class="d-grid">
        <button type="submit" class="btn btn-primary">Send</button>
      </div>
    </form>
  </div>
</div>

<script>
  let stompClient = null;

  function connect() {
    const socket = new SockJS('/chat-websocket');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function () {
      stompClient.subscribe('/topic/messages', function (msg) {
        const data = JSON.parse(msg.body);
        const chatBox = document.getElementById('chat-box');
        const newMsg = document.createElement('div');
        newMsg.innerHTML = `<strong>${data.from}</strong>: ${data.text}`;
        chatBox.appendChild(newMsg);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    });
  }

  function sendMessage() {
    const user = document.getElementById('username').value || "Anonymous";
    const text = document.getElementById('message').value;
    if (!text.trim()) return;
    stompClient.send("/app/chat", {}, JSON.stringify({ from: user, text: text }));
    document.getElementById('message').value = '';
  }

  connect();
</script>
</body>
</html>
